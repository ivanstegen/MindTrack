# üîå MindTrack API Documentation

This document describes the Edge Functions API endpoints for MindTrack.

## üåê Base URL

```
Development: http://localhost:54321/functions/v1
Production:  https://your-project.supabase.co/functions/v1
```

## üîê Authentication

All requests must include the Supabase anon key in headers:

```javascript
headers: {
  'Authorization': 'Bearer YOUR_SUPABASE_ANON_KEY',
  'Content-Type': 'application/json'
}
```

---

## üìù Sentiment Analysis

Analyzes journal entry text and returns mood classification.

### Endpoint
```
POST /analyzeSentiment
```

### Request Body

```json
{
  "text": "Today was amazing! I accomplished all my goals and felt really productive."
}
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| text | string | Yes | The journal entry text to analyze (max 5000 chars) |

### Response

```json
{
  "mood_label": "happy",
  "mood_score": 9
}
```

| Field | Type | Description |
|-------|------|-------------|
| mood_label | string | One of: happy, sad, anxious, neutral, excited, calm, stressed |
| mood_score | number | Integer from 1-10 (1=very negative, 10=very positive) |

### Error Response

```json
{
  "error": "Text is required"
}
```

### Example Usage

```javascript
const response = await fetch(
  `${process.env.NEXT_PUBLIC_SUPABASE_URL}/functions/v1/analyzeSentiment`,
  {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY}`,
    },
    body: JSON.stringify({
      text: "I had a wonderful day today!"
    }),
  }
)

const data = await response.json()
console.log(data) // { mood_label: "happy", mood_score: 8 }
```

### Status Codes

- `200` - Success
- `400` - Bad Request (missing or invalid text)
- `500` - Internal Server Error

### Rate Limits

- **Development**: Unlimited
- **Production**: 100 requests per minute per user

---

## üí¨ AI Coach Chat

Provides context-aware mental wellness coaching responses.

### Endpoint
```
POST /chatCoach
```

### Request Body

```json
{
  "message": "I've been feeling stressed lately. Any advice?",
  "moodHistory": [
    { "mood_label": "stressed", "mood_score": 4 },
    { "mood_label": "anxious", "mood_score": 5 }
  ],
  "recentJournal": [
    {
      "entry_date": "2024-10-28",
      "text": "Work has been overwhelming...",
      "mood_score": 4
    }
  ],
  "activeChallenges": [
    {
      "description": "Take 10 minutes to practice deep breathing"
    }
  ]
}
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| message | string | Yes | User's message/question |
| moodHistory | array | No | Recent mood data for context |
| recentJournal | array | No | Recent journal entries |
| activeChallenges | array | No | Current active challenges |

### Response

**Streaming Response** (Server-Sent Events)

```
data: {"choices":[{"delta":{"content":"I"}}]}
data: {"choices":[{"delta":{"content":" understand"}}]}
data: {"choices":[{"delta":{"content":" that"}}]}
...
data: [DONE]
```

The response streams back text chunks as they're generated by the AI.

### Error Response

```json
{
  "error": "Failed to generate response"
}
```

### Example Usage

```javascript
const response = await fetch(
  `${process.env.NEXT_PUBLIC_SUPABASE_URL}/functions/v1/chatCoach`,
  {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY}`,
    },
    body: JSON.stringify({
      message: "How can I improve my mood?",
      moodHistory: [
        { mood_label: "sad", mood_score: 4 },
        { mood_label: "neutral", mood_score: 6 }
      ],
    }),
  }
)

// Handle streaming response
const reader = response.body.getReader()
const decoder = new TextDecoder()

while (true) {
  const { done, value } = await reader.read()
  if (done) break
  
  const chunk = decoder.decode(value)
  // Process each chunk...
}
```

### Status Codes

- `200` - Success (streaming)
- `400` - Bad Request (missing message)
- `500` - Internal Server Error

### Rate Limits

- **Development**: Unlimited
- **Production**: 20 requests per minute per user

---

## üóÑÔ∏è Database API

Supabase automatically generates REST and GraphQL APIs for all tables.

### Base URL
```
https://your-project.supabase.co/rest/v1
```

### Authentication

Use the anon key or service role key depending on access level needed.

### Example: Get Journal Entries

```javascript
const { data, error } = await supabase
  .from('journal_entries')
  .select('*')
  .eq('user_id', userId)
  .order('entry_date', { ascending: false })
  .limit(10)
```

### Example: Create Habit

```javascript
const { data, error } = await supabase
  .from('habits')
  .insert({
    user_id: userId,
    name: 'Morning Meditation',
    description: 'Meditate for 10 minutes',
  })
  .select()
  .single()
```

### Example: Update Habit Completion

```javascript
const { data, error } = await supabase
  .from('habit_history')
  .upsert({
    habit_id: habitId,
    date: '2024-10-28',
    completed: true,
  })
```

---

## üîí Security

### Row-Level Security (RLS)

All database tables have RLS enabled. Users can only:
- View their own data
- Insert their own data
- Update their own data
- Delete their own data

### API Key Security

**Never** expose your service role key in client-side code. Only use:
- `NEXT_PUBLIC_SUPABASE_URL` - ‚úÖ Safe in client
- `NEXT_PUBLIC_SUPABASE_ANON_KEY` - ‚úÖ Safe in client
- `SUPABASE_SERVICE_ROLE_KEY` - ‚ùå Server-only

### Input Validation

All Edge Functions validate input:
- Text length limits
- Required field checks
- Type validation

---

## üß™ Testing

### Test Sentiment Analysis

```powershell
# Using curl (PowerShell)
curl -X POST `
  https://your-project.supabase.co/functions/v1/analyzeSentiment `
  -H "Authorization: Bearer YOUR_ANON_KEY" `
  -H "Content-Type: application/json" `
  -d '{"text":"I feel great today!"}'
```

### Test Chat Coach

```powershell
curl -X POST `
  https://your-project.supabase.co/functions/v1/chatCoach `
  -H "Authorization: Bearer YOUR_ANON_KEY" `
  -H "Content-Type: application/json" `
  -d '{"message":"How can I reduce stress?"}'
```

---

## üìä Monitoring

### View Edge Function Logs

```powershell
# View recent logs
supabase functions logs analyzeSentiment

# Stream logs in real-time
supabase functions logs chatCoach --follow
```

### Supabase Dashboard

1. Go to **Edge Functions** in Supabase Dashboard
2. Select a function
3. View:
   - Invocation count
   - Error rate
   - Response times
   - Recent logs

---

## üêõ Common Errors

### Error: "Failed to analyze sentiment"

**Causes:**
- OpenAI API key not set
- OpenAI API rate limit exceeded
- Invalid API key
- Network timeout

**Solution:**
```powershell
# Check secrets
supabase secrets list

# Set API key
supabase secrets set OPENAI_API_KEY=your-key

# Redeploy
supabase functions deploy analyzeSentiment
```

### Error: "CORS policy blocked"

**Cause:** Missing CORS headers

**Solution:** Edge Functions include CORS headers by default. If still blocked:
- Check browser console for specific error
- Verify request headers
- Test in Supabase Dashboard first

### Error: "Authentication required"

**Cause:** Missing or invalid Authorization header

**Solution:**
```javascript
// Ensure header is included
headers: {
  'Authorization': `Bearer ${process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY}`
}
```

---

## üìà Performance Tips

1. **Batch Requests**: Combine multiple database queries
2. **Cache Results**: Cache sentiment analysis for entries
3. **Optimize Queries**: Use select() to fetch only needed fields
4. **Use Indexes**: Database queries use indexes for speed
5. **Connection Pooling**: Enable in Supabase settings

---

## üîÑ Versioning

Current API Version: **v1**

Breaking changes will be released as new versions (v2, v3, etc.)

---

## üìû Support

- **Supabase Docs**: https://supabase.com/docs
- **OpenAI API Docs**: https://platform.openai.com/docs
- **GitHub Issues**: Open an issue for bugs

---

**Last Updated**: October 28, 2024
